{% extends 'base.html' %}

{% block title %}Ä°ÅŸleniyor - AkÄ±llÄ± Palet YerleÅŸtirme{% endblock %}

{% block content %}
<div class="py-8 max-w-3xl mx-auto">
    <div class="text-center mb-8">
        <div class="inline-block animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600 mb-4"></div>
        <h2 class="text-2xl font-bold text-gray-800 mb-2">Optimizasyon Ã§alÄ±ÅŸÄ±yor, lÃ¼tfen bekleyin...</h2>
        <p id="progressText" class="text-gray-600">Veri iÅŸleniyor...</p>
    </div>
    
    <div class="mb-6 bg-gray-200 rounded-full h-4 overflow-hidden">
        <div id="progressBar" class="bg-blue-600 h-4 w-0 transition-all duration-500"></div>
    </div>
    
    <div class="bg-gray-900 text-white font-mono text-sm p-4 rounded-xl shadow-inner h-64 overflow-auto">
        <div id="logContainer" class="whitespace-pre-line"></div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    $(document).ready(function() {
        const logContainer = $('#logContainer');
        const progressBar = $('#progressBar');
        const progressText = $('#progressText');
        
        let completed = false;
        let lastStepCount = 0;
        let retryCount = 0;
        let maxRetries = 3;
        let timeoutId;
        let requestInProgress = false;
        
        // Ä°ÅŸlem durumunu kontrol et
        function checkStatus() {
            if (completed || requestInProgress) return;
            
            requestInProgress = true;
            
            $.ajax({
                url: '{% url "palet_app:optimization_status" %}',
                type: 'GET',
                dataType: 'json',
                timeout: 10000,  // 10 saniye timeout
                success: function(response) {
                    requestInProgress = false;
                    retryCount = 0;  // BaÅŸarÄ±lÄ± istek, retry sayacÄ±nÄ± sÄ±fÄ±rla
                    
                    if (response.success) {
                        if (response.completed) {
                            // Ä°ÅŸlem tamamlandÄ±, analiz sayfasÄ±na yÃ¶nlendir
                            completed = true;
                            progressBar.css('width', '100%');
                            progressText.text('Optimizasyon tamamlandÄ±! YÃ¶nlendiriliyor...');
                            addLogMessage('âœ“ Ä°ÅŸlem baÅŸarÄ±yla tamamlandÄ±!');
                            
                            setTimeout(function() {
                                window.location.href = response.next_url;
                            }, 1500);
                        } else {
                            // Ä°lerleme Ã§ubuÄŸunu gÃ¼ncelle
                            const progress = (response.current_step / response.total_steps) * 100;
                            progressBar.css('width', `${progress}%`);
                            
                            // MesajlarÄ± gÃ¼ncelle, ancak yalnÄ±zca yeni mesajlarÄ± ekle
                            if (response.messages.length > lastStepCount) {
                                for (let i = lastStepCount; i < response.messages.length; i++) {
                                    addLogMessage(response.messages[i]);
                                }
                                lastStepCount = response.messages.length;
                            }
                            
                            // HatayÄ± kontrol et
                            if (response.current_step < 0) {
                                progressText.text('Bir hata oluÅŸtu!');
                                addLogMessage('âš  Ä°ÅŸlem sÄ±rasÄ±nda bir hata oluÅŸtu. LÃ¼tfen tekrar deneyin.', true);
                                completed = true;
                            } else {
                                // Duruma gÃ¶re metni gÃ¼ncelle
                                progressText.text(`AdÄ±m ${response.current_step} / ${response.total_steps}: Ä°ÅŸleniyor...`);
                            }
                            
                            // Tekrar kontrol et (2 saniye sonra)
                            if (!completed) {
                                timeoutId = setTimeout(checkStatus, 2000);
                            }
                        }
                    } else {
                        // Hata
                        addLogMessage('âš  Hata: ' + response.error, true);
                        progressText.text('Bir hata oluÅŸtu!');
                        completed = true;
                    }
                },
                error: function(xhr, status, error) {
                    requestInProgress = false;
                    
                    if (status === 'timeout') {
                        addLogMessage('â± Ä°stek zaman aÅŸÄ±mÄ±na uÄŸradÄ±. Yeniden deneniyor...');
                    } else {
                        retryCount++;
                        addLogMessage(`âš  BaÄŸlantÄ± hatasÄ± (Deneme ${retryCount}/${maxRetries})`);
                    }
                    
                    // Maksimum deneme sayÄ±sÄ±na ulaÅŸÄ±ldÄ±ysa durdur
                    if (retryCount >= maxRetries) {
                        addLogMessage('âœ— Sunucu ile iletiÅŸim kurulamadÄ±. LÃ¼tfen sayfayÄ± yenileyin.', true);
                        progressText.text('BaÄŸlantÄ± hatasÄ±!');
                        completed = true;
                    } else if (!completed) {
                        // Yeniden dene (5 saniye sonra)
                        timeoutId = setTimeout(checkStatus, 5000);
                    }
                }
            });
        }
        
        // Log mesajÄ± ekle
        function addLogMessage(message, isError = false) {
            const timestamp = new Date().toLocaleTimeString();
            const msgClass = isError ? 'text-red-500' : 'text-green-400';
            
            const logEntry = $(`<div class="${msgClass}">[${timestamp}] ${message}</div>`);
            logContainer.append(logEntry);
            
            // Otomatik kaydÄ±r
            const container = document.getElementById('logContainer');
            container.scrollTop = container.scrollHeight;
        }
        
        // Sayfa kapatÄ±lÄ±rken temizlik
        $(window).on('beforeunload', function() {
            if (timeoutId) {
                clearTimeout(timeoutId);
            }
        });
        
        // BaÅŸlangÄ±Ã§ â€‹â€‹mesajÄ±
        const algoritma = '{{ request.session.algoritma|default:"greedy" }}';
        addLogMessage('ğŸš€ Optimizasyon iÅŸlemi baÅŸlatÄ±lÄ±yor...');
        
        {% if request.session.container_info %}
        addLogMessage('ğŸ“¦ Container: {{ request.session.container_info.length }}x{{ request.session.container_info.width }}x{{ request.session.container_info.height }} cm');
        {% endif %}
        
        if (algoritma === 'genetic') {
            addLogMessage('ğŸ§¬ Genetik Algoritma (GA) motoru aktif');
            addLogMessage('   â†’ HÄ±zlÄ± yakÄ±nsama, gÃ¼venilir sonuÃ§lar');
            addLogMessage('â³ Bu iÅŸlem 1-3 dakika sÃ¼rebilir...');
        } else if (algoritma === 'differential_evolution') {
            addLogMessage('âš›ï¸ Differential Evolution (DE) motoru aktif');
            addLogMessage('   â†’ Ä°leri seviye optimizasyon, fitness Ã¶nbellekleme');
            addLogMessage('   â†’ Ä°ki aÅŸamalÄ± deÄŸerlendirme sistemi');
            addLogMessage('â³ Bu iÅŸlem 1-3 dakika sÃ¼rebilir...');
        } else {
            addLogMessage('âš¡ Greedy algoritmasÄ± aktif');
            addLogMessage('â³ Ä°ÅŸlem 30-60 saniye sÃ¼rebilir...');
        }
        
        // Ä°lk durumu kontrol et
        setTimeout(checkStatus, 1000);
    });
</script>
{% endblock %} 